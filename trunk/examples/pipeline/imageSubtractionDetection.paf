#<?cfg paf policy ?>
#
# Pipeline Layer Policy
#

# this part is used by the orchestration layer to determine if
# this pipeline can run on a particular platform or with a particular
# database server
#
requires: {
   database: {
      type:  MySQL

   }

   platform: {
      # minNodeCount:  4
      # minCoresPerNode:  8
      minCoreCount:  2
   }
}

# this part is used by the orchestration layer to 
setup: {

   # the schema of this item is determined by the database type given 
   # above in requires.database.type.  
   database:  {
      # 
      # scriptRepository: /lsst/...

      script: lsstSchema4mysql.sql
      script: lsstPipelineSetup4mysql.sql
   }

   data:  {
      
   }
}

framework: {

   # the type determines the schema of the "execute" policy below
   type:  standard

   # this is the file that should be sourced to set the environment on
   # the head node where the pipeline is executed.  The file path component
   # can be represented as $ENVVAR which will be replaced with the
   # value of the environment variable with the name ENVVAR.
   # 
   environment: "$CTRL_ORCA_DIR/examples/etc/setup.sh"

   # this is the execution script that we will use to start the
   # pipeline on the head node of the platform.  The file path component
   # can be represented as $ENVVAR which will be replaced with the
   # value of the environment variable with the name ENVVAR.
   # 
   exec:  "$PEX_HARNESS_DIR/bin/launchPipeline.sh"
}

# the contents of this item is passed to the harness to configure the
# pipeline at launch time.
# 
execute: {

   # executionMode: "oneloop" ,
   # shutdownTopic: "triggerShutdownEvent" 

   localLogMode:  true
   shutdownTopic:  triggerSundownA

   appStage: {
      stageName:   lsst.pex.harness.SymLinkStage.SymLinkStage
      eventTopic:  triggerVisitEvent
      stagePolicy: imageSubtractionDetection/symlink_policy.paf
   }

   appStage: {
      stageName:   lsst.pex.harness.IOStage.InputStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/input_policy.paf
   }

   appStage: {
      stageName:   lsst.ip.diffim.pipeline.VisitMetadataStage
      eventTopic:  None
      stagePolicy: None
   }

   appStage: {
      stageName:   lsst.pex.harness.IOStage.OutputStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/metadataOutput_policy.paf
   }

   appStage: {
      stageName:   lsst.pex.harness.IOStage.OutputStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/exposureOutput_policy.paf
   }

   appStage: {
      stageName:   lsst.ip.diffim.pipeline.ImageSubtractStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/imageSubtraction.paf
   }

   appStage: {
      stageName:   lsst.pex.harness.IOStage.OutputStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/subtractOutput_policy.paf
   }

   appStage: {
      stageName:   lsst.detection.pipeline.DetectionStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/detection.paf
   }

   appStage: {
      stageName:   lsst.pex.harness.IOStage.OutputStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/detectOutput_policy.paf
   }

   appStage: {
      stageName:   lsst.pex.harness.EventStage.EventStage
      eventTopic:  None
      stagePolicy: imageSubtractionDetection/associationEvent_policy.paf
   }

   # the rest items will get overridden by the policy passed from the
   # orchestration layer.  It appears here as default values for when
   # the pipeline is launch directly via pipeline harness rather than
   # via the orchestration layer (e.g. for testing purposes).  

   eventBrokerHost:  lsst8.ncsa.uiuc.edu

   dir: {

      # the default root directory all files read or written by pipelines
      # deployed on this platform.  
      # This can be overriden by any of the "named role" directories below.
      #
      defaultRoot:  .

      # These indicate the directory that should be used for a named purpose.
      # If relative paths are given, the resulting directory will be relative
      # to the default run directory (determined by defaultRoot and the 
      # runDirPattern).  These can be given as patterns specified in the same 
      # format as runDirPattern.  (If a directory is given as an absolute path,
      # using a pattern is recommended in order to distinguish between different 
      # production runs.)
      #
      work:     .    # the working directory, where the pipeline is started
      input:    .    # the directory to cache/find input data
      output:   .    # the directory to write output data
      update:   .    # the directory where updatable data is deployed
      scratch:  .    # a directory for temporary files that may be deleted 
                     #   upon completion of the pipeline

   }
}
